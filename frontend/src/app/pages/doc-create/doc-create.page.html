<div class="page-wrapper">

  @if (isInitial) {
  <p-dialog header="הגדרת מספור" [(visible)]="showInitialIndexDialog" [modal]="true" [rtl]="true"
    [style]="{ width: '400px' }">
    <div class="p-fluid">
      <p>
        היי..<br />
        זוהי הפעם הראשונה שאתה מפיק במערכת <strong>{{ HebrewNameFileSelected }}</strong>.<br />
        אנא בחר את המספור בו תרצה להתחיל:
      </p>
      <div class="p-field">
        <label for="index">מספר התחלה</label>
        <app-input-text [controlName]="'initialIndex'" labelText="" [placeholder]="''" [parentForm]="initialIndexForm"
          [size]="inputsSize.BETWEEN"></app-input-text>
      </div>
      <div>
        <app-p-button [buttonText]=" 'אישור'" [buttonSize]="buttonSize.AUTO"
          (onButtonClicked)="onClickInitialIndex()"></app-p-button>
      </div>
    </div>
  </p-dialog>
  }
  <!-- Document type selection -->
  <div class="section">
    <div class="create-doc-header">
      <div class="icon-title">
        <span class="title">הפקת מסמך</span>
      </div>
      <p class="text-header">
        בחר איזה מסמך ברצונך להפיק
      </p>
    </div>
    <div class="section">
      <div class="create-doc-header">
        <div class="icon-title">
          <span class="title">פרטי המסמך</span>
        </div>
      </div>
      <div class="general-fields">
        <div class="user-details-section">
          @for (item of generalArray; track item.value) {
          @switch (item.type) {

          @case (formTypes.DDL) {
          @if (item.value !== FieldsCreateDocValue.BUSINESS_NUMBER || showBusinessSelector) {
          <app-input-select [controlName]="item.value" [labelText]="item.labelText" [placeholder]="item.placeHolder"
            [items]="item.labelText === 'עסק' ? businessOptions() : item.enumValues" [parentForm]="generalDetailsForm"
            [size]="inputsSize.MEDIUM" (onChangeInputSelect)="onSelectionChange(item.value, $event)" [disabled]="
            item.value === 'docType' && !generalDetailsForm.get('businessNumber')?.value">
          </app-input-select>
          }
          }

          @case (formTypes.DATE) {
          <app-input-date [controlName]="item.value" [labelText]="item.labelText" placeholder="00/00/0000"
            [parentForm]="generalDetailsForm" [size]="inputsSize.MEDIUM">
          </app-input-date>
          }

          @default {
          @if (item.value !== FieldsCreateDocValue.DOC_VAT_RATE || isGeneralExpanded) {
          <app-input-text [controlName]="item.value" [value]="item.initialValue" [labelText]="item.labelText"
            [placeholder]="item.placeHolder" [parentForm]="generalDetailsForm" [size]="inputsSize.BETWEEN" [type]="
          item.type === formTypes.NUMBER ? 'number' : 'text'"></app-input-text>
          }
          }

          }
          }
        </div>
        <div>
          <app-p-button class="pnl-pdf-button" [buttonText]="isGeneralExpanded ? 'הסתר שדות' : 'הצג שדות נוספים'"
            [variant]="'text'" [severity]="'info'" [buttonSize]="buttonSize.AUTO"
            (onButtonClicked)="expandGeneralDetails()">
          </app-p-button>
        </div>
      </div>
    </div>

    <!-- Recipient details section -->
    @if (isFileSelected()) {
    <div class="section">
      <div class="create-doc-header">
        <div class="icon-title">
          <span class="title">פרטי הלקוח</span>
        </div>
      </div>
      <div class="general-fields">
        <div class="user-details-section">
          @for (item of userArray; track item.value) {
          @switch (item.type) {
          @case (formTypes.AUTOCOMPLETE) {
          <app-input-autocomplete [labelText]="item.labelText" [parentForm]="userDetailsForm" [controlName]="item.value"
            [placeholder]="item.placeHolder" [items]="filteredClients()" optionLabel="name"
            (onCompleteMethod)="filterClients($event)" (onItemSelect)="onClientSelect($event)" [showAddNew]="true"
            addNewLabel="הוסף לקוח חדש" (onAddNew)="onAddNewClient($event)" headerText="בחר לקוח קיים"
            [forceSelection]="false" [size]="inputsSize.BETWEEN">
          </app-input-autocomplete>
          }

          @case (formTypes.DDL) {
          <app-input-select [controlName]="item.value" [labelText]="item.labelText" [placeholder]="item.placeHolder"
            [items]="item.enumValues" [parentForm]="userDetailsForm" [size]="inputsSize.BETWEEN">
          </app-input-select>
          }

          @case (formTypes.DATE) {
          <app-input-date [controlName]="item.value" [labelText]="item.labelText" placeholder="00/00/0000"
            [parentForm]="userDetailsForm">
          </app-input-date>
          }

          @default {
          <app-input-text [controlName]="item.value" [labelText]="item.labelText" [placeholder]="item.placeHolder"
            [parentForm]="userDetailsForm" [size]="inputsSize.BETWEEN" [type]="
          item.type === formTypes.NUMBER ? 'number' :
          'text'
        ">
          </app-input-text>
          }

          }
          }
        </div>
        <div>
          <app-p-button class="pnl-pdf-button" [buttonText]="isUserExpanded() ? 'הסתר שדות' : 'הצג שדות נוספים'"
            [variant]="'text'" [severity]="'info'" [buttonSize]="buttonSize.AUTO"
            (onButtonClicked)="expandUserDetails()">
          </app-p-button>
        </div>
      </div>
    </div>

    <!-- line details section -->
    <div class="section">
      <div class="create-doc-header">
        <div class="icon-title">
          <span class="title">פירוט</span>
        </div>
      </div>
      <div class="table-wrapper">
        <p-table [columns]="lineDetailsColumns" [value]="[{}]" [tableStyle]="{ 'min-width': '50rem' }">
          <ng-template pTemplate="header" let-columns>
            <tr>
              <th *ngFor="let col of columns" style="color: gray;"
                [ngStyle]="col.field === FieldsCreateDocValue.VAT_OPTIONS ? { 'padding-right': '40px' } : {}">
                {{ col.header }}
                @if (col.header) {
                <span style="color: red; margin-right: 4px;">*</span>
                }
              </th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-rowData let-columns="columns">
            <tr [formGroup]="lineDetailsForm">
              <td *ngFor="let col of columns"
                [style.width]="col.field === FieldsCreateDocValue.LINE_DESCRIPTION ? '420px' : col.field === FieldsCreateDocValue.UNIT_AMOUNT ? '9%' : ''"
                [ngStyle]="col.field === FieldsCreateDocValue.VAT_OPTIONS ? { 'padding-right': '40px' } : {}">
                @switch (col.field) {

                @case (FieldsCreateDocValue.UNIT_AMOUNT) {
                <p-inputnumber [min]="1" class="plus-minus" [formControlName]="col.field" [showButtons]="true"
                  buttonLayout="horizontal" spinnerMode="horizontal"
                  [inputStyle]="{ width: '3rem', 'text-align': 'center' }"
                  [ngStyle]="{display: 'flex', 'flex-direction': 'row-reverse'}">
                  <ng-template #decrementbuttonicon>
                    <span class="pi pi-minus"></span>
                  </ng-template>
                  <ng-template #incrementbuttonicon>
                    <span class="pi pi-plus"></span>
                  </ng-template>

                </p-inputnumber>
                }

                @case (FieldsCreateDocValue.VAT_OPTIONS) {
                <div class="gender-options-row" role="radiogroup" [attr.aria-labelledby]="'vat-label'">
                  @for (opt of vatOptions; track opt.value; let i = $index) {
                  <!-- Make 'name' and 'inputId' unique per row to prevent cross-row grouping -->
                  <div class="vat-option">
                    <p-radiobutton [formControlName]="col.field" [value]="opt.value" [name]="col.field"
                      [inputId]="col.field + '-' + opt.value" />
                    <label class="ml-2" [for]="col.field + '-' + opt.value">{{ opt.name }}</label>
                  </div>
                  }
                </div>
                }

                @case ('action') {
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                  <app-p-button class="pnl-pdf-button"
                    [buttonText]="editingLineIndex() !== null ? 'עדכן שורה' : 'הוסף שורה'" [variant]="'text'"
                    [severity]="'info'" [buttonSize]="buttonSize.AUTO" [disabled]="!lineDetailsForm.valid"
                    (onButtonClicked)="addLineDetails()">
                  </app-p-button>
                  @if (editingLineIndex() !== null) {
                  <app-p-button class="pnl-pdf-button" [buttonText]="'ביטול'" [variant]="'text'"
                    [severity]="'secondary'" [buttonSize]="buttonSize.AUTO" (onButtonClicked)="cancelEdit()">
                  </app-p-button>
                  }
                </div>
                }

                @default {
                <app-input-text [controlName]="col.field" [placeholder]="col.header" [parentForm]="lineDetailsForm"
                  [type]="col.field === FieldsCreateDocValue.LINE_DESCRIPTION ? 'text' : 'number'"
                  [size]="col.field === FieldsCreateDocValue.LINE_DESCRIPTION ? inputsSize.LARGE : inputsSize.SMALL"></app-input-text>
                }

                }
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      @if (lineItemsDraft().length > 0) {
      <div class="line-items-table" style="margin-top: 2rem;">
        <p-table [columns]="filteredLineItemsDisplayColumns()" [value]="lineItemsDraft()">
          <ng-template pTemplate="header" let-columns>
            <tr style="background-color: #f5f5f5;">
              <th *ngFor="let col of columns" style="background-color: #dcdbdb;">{{ col.header }}</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-line let-columns="columns" let-rowIndex="rowIndex">
            <tr [style.background-color]="editingLineIndex() === rowIndex ? '#e3f2fd' : 'transparent'">
              <td *ngFor="let col of columns">
                @if (col.dataField === 'description') {
                {{ line.description }}
                }
                @else if (col.dataField === 'unitQuantity') {
                {{ line.unitQuantity }}
                }
                @else if (col.dataField === 'vatOpts') {
                <span dir="ltr">
                  ₪{{ line.vatPerLine | number:'1.2-2' }}
                </span>
                }
                @else if (col.dataField === 'sum') {
                <span dir="ltr">
                  ₪{{ line.sumBefVatPerUnit | number:'1.2-2' }}
                </span>
                }
                @else if (col.dataField === 'total') {
                <span dir="ltr">
                  ₪{{ line.sumAftDisWithVat | number:'1.2-2' }}
                </span>
                }
                @else if (col.dataField === 'discount') {
                {{ line.discount ?? '-' }}
                }
                @else if (col.dataField === 'actions') {
                <div style="display: flex; gap: 0.5rem;">
                  <app-p-button [buttonColor]="buttonColor.TRANSPARET" [buttonSize]="buttonSize.ICON" [iconOnly]="true"
                    [severity]="'info'" [variant]="'text'" [icon]="'pi pi-pen-to-square'"
                    (onButtonClicked)="editLine(rowIndex)" title="עריכה">
                  </app-p-button>
                  <app-p-button [buttonColor]="buttonColor.TRANSPARET" [buttonSize]="buttonSize.ICON" [iconOnly]="true"
                    [severity]="'info'" [variant]="'text'" [icon]="'pi pi-trash'"
                    (onButtonClicked)="deleteLine(rowIndex)" title="מחיקה">
                  </app-p-button>
                </div>
                }
              </td>
            </tr>
          </ng-template>
        </p-table>

        <div class="totals-summary">
          <div class="keys-summary">
            @for (item of filteredSummaryItems(); track item.key) {
            <p class="content-summary">{{ item.label }}</p>
            }
          </div>
          <div class="values-summary">
            @for (item of filteredSummaryItems(); track item.key) {
            <p class="content-summary">
              <span dir="ltr">
                ₪{{ item.valueGetter(documentSummary()) | number:'1.2-2' }}
              </span>
            </p>
            }
          </div>
        </div>
      </div>
      }
    </div>

    <!-- payments -->
    @if (isDocWithPayments()) {

    <div class="section">

      <!-- Section Header -->
      <div class="create-doc-header">
        <div class="icon-title">
          <span class="title">תשלומים</span>
        </div>
      </div>

      <!-- Tab Menu for Payment Method -->
      <p-tabMenu [model]="paymentMethodOptions" [activeItem]="activePaymentMethod"
        (activeItemChange)="onPaymentMethodChange($event)">
      </p-tabMenu>

      <!-- Payment Entry Row -->
      <div class="line-item-row">

        <!-- Header Row -->
        <div class="fields-grid fields-header">
          @for (item of getPaymentFields(activePaymentMethod.id); track item.value) {
          <div>{{ item.labelText || item.value }}</div>
          }
        </div>

        <hr class="fields-divider" />

        <!-- Input Row -->
        <form [formGroup]="paymentInputForm">
          <div class="fields-grid fields-row">
            @for (item of getPaymentFields(activePaymentMethod.id); track item.value) {
            @switch (item.type) {
            @case (formTypes.DATE) {
            <app-input-date [controlName]="item.value" [placeholder]="item.placeHolder"
              [parentForm]="paymentInputForm"></app-input-date>
            }
            @case (formTypes.DDL) {
            <app-input-select [controlName]="item.value" [placeholder]="item.placeHolder" [items]="item.enumValues"
              [parentForm]="paymentInputForm" [size]="inputsSize.AUTO"></app-input-select>
            }
            @default {
            <app-input-text [controlName]="item.value" [placeholder]="item.placeHolder" [parentForm]="paymentInputForm"
              [type]="item.type === formTypes.NUMBER ? 'number' : 'text'" [min]="1"
              [size]="inputsSize.SMALL"></app-input-text>
            }
            }
            }

            <!-- Add Button -->
            <app-p-button class="pnl-pdf-button" [buttonText]="'הוסף תשלום'" [variant]="'text'" [severity]="'info'"
              [buttonSize]="buttonSize.AUTO" [disabled]="!paymentInputForm.valid" (onButtonClicked)="addPayment()">
            </app-p-button>
          </div>
        </form>

      </div>

      <!-- Display Added Payments -->
      @if (paymentsDraft().length > 0) {
      <div class="line-items-table">
        <!-- Payment Rows (each with its own header based on its method) -->
        @for (payment of paymentsDraft(); track $index) {
        <div class="line-row header">
          @for (item of getPaymentFields(payment.paymentMethod); track item.value) {
          <div>{{ item.labelText || item.value }}</div>
          }
        </div>

        <hr class="fields-divider" />

        <div class="line-row">
          @for (item of getPaymentFields(payment.paymentMethod); track item.value) {
          <div>
            @if (item.value === 'paymentSum') {
            <span dir="ltr">₪{{ payment[item.value] | number:'1.2-2' }}</span>
            } @else {
            {{ item.type === formTypes.DATE
            ? (payment[item.value] | date:'dd/MM/yyyy')
            : (
            item.value === 'bankName'
            ? (
            payment.hebrewBankName && payment.bankNumber
            ? (payment.hebrewBankName + ' (' + payment.bankNumber + ')')
            : (payment.hebrewBankName || payment.bankNumber || '-')
            )
            : (payment[item.value] || '-')
            )
            }}
            }
          </div>
          }
          <div class="actions">
            <app-p-button [buttonColor]="buttonColor.TRANSPARET" [buttonSize]="buttonSize.ICON" [iconOnly]="true"
              [icon]="'pi pi-trash'" (onButtonClicked)="deletePayment($index)"></app-p-button>
          </div>
        </div>
        }
      </div>
      }

      @if (chargesPaymentsDifference() !== 0) {
      <div>
        <p class="error-difference">אין התאמה בין סכום המסמך לבין סכום התשלומים</p>
        <p class="amount">{{ chargesPaymentsDifference() < 0 ? 'תשלום עודף של:' : 'יתרה לתשלום' }} <span
            class="amount-value">
            <span dir="ltr">
              ₪{{ chargesPaymentsDifference() | number:'1.2-2' }}
            </span>
            </span>
        </p>
      </div>
      }
    </div>
    }
    <div class="buttons-container">
      <div>
        <app-p-button class="pnl-pdf-button" [buttonText]="'תצוגה מקדימה'" [buttonSize]="buttonSize.AUTO"
          [buttonColor]="buttonColor.WHITE_BORDER" [disabled]="!createDocIsValid()" (onButtonClicked)="previewDoc()"
          [isLoading]="createPreviewPDFIsLoading()">
        </app-p-button>
      </div>
      <div>
        <app-p-button class="pnl-pdf-button" [buttonText]="'צור מסמך'" [buttonSize]="buttonSize.SMALL"
          [disabled]="!createDocIsValid()" [isLoading]="createPDFIsLoading()" (onButtonClicked)="confirmCreateDoc()"
          [buttonColor]="buttonColor.BLACK">
        </app-p-button>
      </div>

    </div>
    }

  </div>

  <!-- SHAAM Invoice Approval Dialog -->
  <app-shaam-invoice-approval-dialog
    [isVisible]="showShaamDialog()"
    [businessNumber]="selectedBusinessNumber"
    (visibleChange)="onShaamDialogClose($event)"
    (approvalSuccess)="onShaamApprovalSuccess($event)">
  </app-shaam-invoice-approval-dialog>

  <!-- Manual Allocation Number Input Dialog -->
  <p-dialog 
    header="הזנת מספר הקצאה ידנית" 
    [visible]="showAllocationNumberInput()" 
    [modal]="true" 
    [rtl]="true"
    [style]="{ width: '400px' }"
    (onHide)="cancelAllocationNumberInput()">
    <div class="p-fluid">
      <p>אנא הזן את מספר ההקצאה שקיבלת משעמ:</p>
      <div class="p-field">
        <label for="allocationNumber">מספר הקצאה</label>
        <input 
          id="allocationNumber"
          type="text" 
          class="p-inputtext p-component" 
          [(ngModel)]="manualAllocationNumber"
          placeholder="הזן מספר הקצאה"
          style="width: 100%;">
      </div>
      <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
        <app-p-button 
          [buttonText]="'ביטול'" 
          [buttonSize]="buttonSize.AUTO"
          [buttonColor]="buttonColor.WHITE"
          (onButtonClicked)="cancelAllocationNumberInput()">
        </app-p-button>
        <app-p-button 
          [buttonText]="'אישור'" 
          [buttonSize]="buttonSize.AUTO"
          [buttonColor]="buttonColor.BLACK"
          [disabled]="!manualAllocationNumber || !manualAllocationNumber.trim()"
          (onButtonClicked)="onAllocationNumberSubmit(manualAllocationNumber)">
        </app-p-button>
      </div>
    </div>
  </p-dialog>

  <!-- Toast for messages -->
  <p-toast key="br"></p-toast>
  
  <!-- Confirmation Dialog for PrimeNG ConfirmationService -->
  <p-confirmDialog></p-confirmDialog>




  <ng-template #initialTemplate>
    <ng-container *ngIf="fileSelected">

      <p>
        היי תמיד יש פעם ראשונה...
        <br />
        כמה הגדרות קצרות ונמשיך להפקת ה{{HebrewNameFileSelected}}
      </p>
      <form class="" [formGroup]="initialIndexForm">
        <app-generic-input inputLabel="באיזה מספר סידורי תרצה להתחיל?" [parentForm]="initialIndexForm"
          controlName="initialIndex" errorText="מספרים בלבד"></app-generic-input>
      </form>
      <!-- <app-button buttonText="Save" (onButtonClicked)="onClickInitialIndex()"
        [disabled]="initialIndexForm.invalid"></app-button> -->
    </ng-container>
  </ng-template>